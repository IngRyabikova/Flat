#include "TXLib.h"
#include "Bed.cpp"
#include "Button.cpp"
#include <fstream>
#include <iostream>

using namespace std;

int getWidth(const char* address)
{
    char header[54];
    ifstream bmp;
    bmp.open(address, ios::in | ios::binary);

    bmp.read(header, 54);
    int width = *(int *)&header[18];
    return width;
}
int getHeight(const char* address)
{
    char header[54];
    ifstream bmp;
    bmp.open(address, ios::in | ios::binary);

    bmp.read(header, 54);
    int width = *(int *)&header[22];
    return width;
}

void drawObl(HDC Krestik)
{
    int x_Krestik = 1100;
    int y_Krestik = 60;

    txSetColor(TX_ORANGE);
    txSetFillColor(TX_WHITE);
    txRectangle(1100, 60, 1300, 750);
    txTransparentBlt(txDC(), x_Krestik, y_Krestik, 60, 60, Krestik, 0, 0, TX_WHITE);
}

int Bot_reading(const char* address, Picture*variants, int N)
{
    setlocale(LC_ALL, "Russian");
    WIN32_FIND_DATA FindFileData;
    HANDLE hf;
    string str = address;
    str = str + "*";

    hf=FindFirstFile(str.c_str(), &FindFileData);

    //
    if (hf!=INVALID_HANDLE_VALUE){
        do{

            str = FindFileData.cFileName;
            str = (string)address + str;

            if (str.find(".bmp") != -1)
            {
                string s = str;
                variants[N] = {s.c_str()};
                N = N + 1;
                txSleep(20);
            }
        }
        while (FindNextFile(hf,&FindFileData)!=0);
        FindClose(hf);
    }

    return N;
}


int main()
{
    txCreateWindow (1300, 750);


    string category = "";

    HDC Fon = txLoadImage("Картинки/Координатная сетка.bmp");
    int x_Fon = 0;
    int y_Fon = 0;

    HDC Krestik = txLoadImage("Картинки/Кнопки/Knopochka.bmp");
    int x_Krestik = 1100;
    int y_Krestik = 60;

    int count_button = 8;
    button Button[count_button];
    //Можно 2 кнопку, но у нее размер другой  #О чем речь? ##Есть более мелкая картинка
    Button[0] = {txLoadImage("Картинки/Кнопки/Кнопка.bmp"), 0, 0, "Планировки","Plan", 200, 60};
    Button[1] = {Button[0].picture, 0, 0, "Кровати","Кровати", 200, 60};
    Button[2] = {Button[0].picture, 0, 0, "Столы", "Столы", 200, 60};
    Button[3] = {Button[0].picture, 0, 0, "Диваны", "Диваны", 200, 60 };
    Button[4] = {Button[0].picture, 0, 0, "Кухня", "туалет", 200, 60};
    Button[5] = {Button[0].picture, 0, 0, "Сохранить", "Save", 200, 60};
    Button[6] = {Button[0].picture, 0, 0, "Загрузить", "Load", 200, 60};
    Button[7] = {Button[0].picture, 0, 0, "Меню", "туалет", 200, 60};




    //Расставляем координаты и ширину кнопкам
    for(int i = 0; i < count_button; i++)
    {
        Button[i].y = 0;
        Button[i].x = 1298 * i / count_button;
        Button[i].width = 1200 / count_button;
    }

    //Координаты кнопок выбора мебели на PAGE = "redactor"
    /*for(int i = 0; i < count_button; i = i + 1)
    {
        Button[i].y = 0;
        Button[i].x = i * 250;
        Ширина, высота
    } */

    HDC button_0 = txLoadImage("Картинки/Кнопки/Кнопка.bmp");
    int x_button_0 = 0;
    int y_button_0 = 0;

    HDC Strelka =  txLoadImage("Картинки/Кнопки/Стрелочка.bmp");
    int x_Strelka= 0;
    int y_Strelka = 0;



    //Меню стартовой страницы
    button Button_MENU[3];
    Button_MENU[0] = {txLoadImage("Картинки/Меню/Шестерёнка.bmp"), 390, 340, " ", "settings", 457, 122};
    Button_MENU[1] = {txLoadImage("Картинки/Меню/Плей.bmp"), 387, 187, " ", "start", 448, 132};
    Button_MENU[2] = {txLoadImage("Картинки/Меню/Дверь.bmp"), 355, 480, " ", "exit", 468, 140};
    const char* PAGE = "start";

    if (category == "redactor")
        PAGE = "start";

    button Menu = {txLoadImage("Картинки/Меню/Меню.bmp"), 0, 0, ""};
    //button Pause = {txLoadImage("Картинки/Меню/Пауза.bmp"), 1200, 0,  "", "", 0};

    HDC reklama = txLoadImage("Картинки/Меню/Реклама 1.bmp");
    int x_reklama = 0;
    int y_reklama = 0;

    bool mouse1 = false;

    //Это да
    bool drawOBL = false;
    int Active_Pic = -1;
    bool klik = true;

    int count_variants = 0;
    Picture variants[777];

    count_variants = Bot_reading("Картинки/Кровати/", variants, count_variants);
    count_variants = Bot_reading("Картинки/Столы/", variants, count_variants);

    for (int nomer = 0; nomer < count_variants; nomer = nomer + 1)
    {
        string s = variants[nomer].address;
        int pos = s.find("/", 0);
        int pos2 = s.find("/",pos + 1);
        variants[nomer].category = s.substr(pos + 1,pos2 - pos - 1);  //От первого / до второго

        variants[nomer].visible = false;

        variants[nomer].picture1 = txLoadImage(variants[nomer].address.c_str());
        variants[nomer].picture2 = txLoadImage(("1" + (string)variants[nomer].address).c_str());
        variants[nomer].picture = variants[nomer].picture1;

        //Ширина и высота из свойств файла
        variants[nomer].width = getWidth (variants[nomer].address.c_str());
        variants[nomer].x = 1100 + ((150 - variants[nomer].width) / 2);
        variants[nomer].height = getHeight(variants[nomer].address.c_str());
    }


    int y_Bed = 150;        //Координаты кроватей variants
    int y_Sofa = 150;       //Координаты диванов variants
    int y_Table = 150;      //Координаты столов variants
    int y_Kuhna = 150;      //Координаты Kuhna variants
    for (int i = 0; i < count_variants; i = i + 1)
    {
        if (variants[i].category == "Кровати")
        {
            variants[i].y = y_Bed;
            y_Bed = y_Bed + 150;
        }
        if (variants[i].category == "Диваны")
        {
            variants[i].y = y_Sofa;
            y_Sofa = y_Sofa + 100;
        }

        if(variants[i].category == "Столы")
        {
            variants[i].y = y_Table;
            y_Table = y_Table + 150;
        }
        if(variants[i].category == "туалет")
        {
            variants[i].y = y_Kuhna;
            y_Kuhna = y_Kuhna + 100;
        }
    }


    int count_Plans = 3;
    Picture Plans[count_Plans];
    Plans[0] = {"Картинки/Планы/План_1.bmp", false, "Plan"};
    Plans[1] = {"Картинки/Планы/План_2.bmp", false, "Plan"};
    Plans[2] = {"Картинки/Планы/План_3.bmp", false, "Plan"};



    int y_Plans = 150;      //Координаты планов variants
    for (int nomer = 0; nomer < count_Plans; nomer = nomer + 1)
    {
        Plans[nomer].picture = txLoadImage(Plans[nomer].address.c_str());
        Plans[nomer].width = getWidth (Plans[nomer].address.c_str());
        Plans[nomer].height = getHeight(Plans[nomer].address.c_str());

        Plans[nomer].x = 1100;
        if(Plans[nomer].category == "Plan")
        {
            Plans[nomer].y = y_Plans;
            y_Plans = y_Plans + 200;
        }
    }



    HDC Plan_ = Plans[0].picture;
    int x_Plan_ = 0;
    int y_Plan_ = 0;




    //Центр. картинки
    Picture Bed2[2500];
    int n_pics = 0;









   //int n_pics2 = 0;
    string strokaX;
    string strokaY;
    string address;



    while(!GetAsyncKeyState(VK_ESCAPE))
    {
        txBegin();
        txClear();

        //Стартовая страница)
        if (PAGE == "start")
        {
            txTransparentBlt (txDC(), Menu.x, Menu.y, 1300, 750, Menu.picture, 0,  0, RGB(255, 127, 39));

            //Надпись в меню / название
            txSelectFont ("Comic Sans MS", 80);
            txSetColor(TX_RED);
            txDrawText(0, 0, txGetExtentX(), txGetExtentY() / 3, "Создай свой дизайн квартиры" );

            //Кнопки в меню
            for(int nomer = 0; nomer < 3; nomer = nomer +1)
            {
                if (txMouseX() >= Button_MENU[nomer].x &&
                    txMouseY() >= Button_MENU[nomer].y &&
                    txMouseX() <= Button_MENU[nomer].x + 500 &&
                    txMouseY() <= Button_MENU[nomer].y + 100)
                {
                    Button_MENU[nomer].draw2();
                }
            }

            //Клик на выход
            if (Button_MENU[2].click())
            {
                txDisableAutoPause();
                return 0;
            }

            //Клик на играть
            if (Button_MENU[1].click())
            {
                PAGE = "redactor";
            }
            //Клик на справку
            if (Button_MENU[0].click())
            {
                PAGE = "settings";
            }
        }

        //Настройки
        else if(PAGE == "settings")
        {
            txSetFillColor(TX_WHITE);
            txRectangle(0, 0, 1300, 750);

            //Кнопка "назад"
            Win32::TransparentBlt(txDC(), x_Strelka + 5, y_Strelka + 5, 50, 50, Strelka, 0, 0, 225,225, TX_RED);
            txSetColor(TX_BLACK);
            txSelectFont("Comic Sans MS", 50);
            txTextOut(40, 7, "Назад");

            //2 кровати по бокам в справке
            txTransparentBlt(txDC(), 100,  550, 131, 135, variants[0].picture, 0, 0, TX_YELLOW);
            txTransparentBlt(txDC(), 1000, 550, 189, 131, variants[1].picture, 0, 0, TX_YELLOW);
            //Реклама
            txTransparentBlt(txDC(), 500, 450, 300, 200, reklama, 0, 0, TX_YELLOW);

            //Клик на кнопку "назад"
            if (txMouseX() >= 0 && txMouseX() <= 150 &&
                txMouseY() >= 0 && txMouseY() <= 100 &&
                txMouseButtons() & 1)
            {
                PAGE = "start";
                category = "";
            }

            //Текст в справке
            txSetColor(TX_BLACK);
            txSelectFont("Arial", 50);
            txDrawText(200, 100, 1100, 200,
                        "Привет, это симулятор создания квартиры!");
            txSelectFont("Arial", 40);
            txDrawText(270, 200, 1000, 900, "Цель этой игры - весело провести время!\n"
                        "Ты можешь выбирать любой из данных предметов\n"
                        " мебели, перетаскивать их в нужное место,\n"
                        " и построить свою квартиру! Если нужно \n"
                        " удалить предмет, зажми его и нажми Delete!\n");
        }

        //Редактор)
        else if (PAGE == "redactor")
        {

            //Меню
            txSetFillColour(TX_WHITE);
            if (Button[7].click())
            {
                PAGE = "start";
            }

            //Координатная сетка /фон
            txBitBlt(txDC(), x_Plan_, y_Plan_, 1290, 740, Plan_);

            for (int nomer = 0; nomer < count_button; nomer = nomer +1)
            {
                //А что тебе координаты самой кнопки не взять?
                txTransparentBlt(txDC(), x_button_0,  y_button_0, 214, 66, button_0, 0, 0, TX_YELLOW);
                x_button_0 = x_button_0 + 250;
            }

            //Жёлтые кнопки наверху экрана
            for (int nomer = 0; nomer < count_button; nomer = nomer +1)
            {
                //Это что еще такое?
                /*if( txMouseX() >= Button[nomer].x &&
                    txMouseY() >= Button[nomer].y &&
                    txMouseX() <= Button[nomer].x + 200 &&
                    txMouseY() <= Button[nomer].y + 60) */
                {
                    Button[nomer].draw();
                }
            }

            if(drawOBL)
            {
                drawObl(Krestik);
            }


            //Выбор категории
            for(int nomer = 0; nomer < count_button; nomer = nomer + 1)
            {
                if (Button[nomer].click() && mouse1 == false)
                {
                    category = Button[nomer].category;
                    drawOBL = true;

                }
                 //анимация кнопок
                if (txMouseX() >= Button[nomer].x &&
                    txMouseY() >= Button[nomer].y &&
                    txMouseX() <= Button[nomer].x + Button[nomer].width &&
                    txMouseY() <= Button[nomer].y + Button[nomer].height)
                {
                    //PAGE = "start";

                    txSetFillColor(TX_TRANSPARENT);
                    txSetColor(RGB(0, 0, 0), 7);
                    Win32::RoundRect(txDC(), Button[nomer].x + 4, Button[nomer].y + 10, Button[nomer].x + 147, Button[nomer].y + 59, 10, 10);
                }
            }

            //Выход из категории
            if(txMouseX() >= 1100   && txMouseY() >= 60  && txMouseX() <= 1140 && txMouseY() <= 100 &&
                txMouseButtons () ==1)
            {
                drawOBL = false;
                category="";
            }


            //клик на план
            for (int nomer = 0; nomer <  count_Plans; nomer = nomer + 1)
            {
                if (txMouseX() >= Plans[nomer].x    &&
                    txMouseY() >= Plans[nomer].y  &&
                    txMouseX() <= Plans[nomer].x +  150 &&
                    txMouseY() <= Plans[nomer].y +  120 &&
                    txMouseButtons () ==1 && category == Plans[nomer].category)
                {
                    Plan_ = Plans[nomer].picture;
                }
            }


            //Выбор мебели и её рисование(рандомное)
            for (int nomer = 0; nomer <  count_variants; nomer = nomer + 1)
            {
                if (txMouseX() >= variants[nomer].x    &&
                    txMouseY() >= variants[nomer].y  &&
                    txMouseX() <= variants[nomer].x +  variants[nomer].width &&
                    txMouseY() <= variants[nomer].y +  variants[nomer].height &&
                    txMouseButtons () ==1 && category == variants[nomer].category && klik == true)
                {
                     Bed2[n_pics] = {variants[nomer].address,  true, variants[nomer].category, variants[nomer].picture, variants[nomer].picture1, variants[nomer].picture2,
                     random(100, 800), random(100, 600), variants[nomer].width, variants[nomer].height};

                     n_pics++;
                     klik = false;
                }

                /*if (txMouseX() >= variants[nomer].x &&   попытка анимации мебели справа
                    txMouseY() >= variants[nomer].y &&
                    txMouseX() <= variants[nomer].x + variants[nomer].width &&
                    txMouseY() <= variants[nomer].y + variants[nomer].height)
                {
                    //PAGE = "start";

                    txSetFillColor(TX_TRANSPARENT);
                    txSetColor(RGB(170, 220, 25), 7);
                    Win32::RoundRect(txDC(), variants[nomer].x + 4, variants[nomer].y + 10, variants[nomer].x + 170, variants[nomer].y + 59, 10, 10);
                }  */
            }

            //Движение картинки
            Active_Pic = movePic(Bed2, Active_Pic, n_pics);


            //Переворот/перерисовка картинки
                if(GetAsyncKeyState('R') && Active_Pic >= 0)
                {
                    /*
                    string adress = variants[nomer].addres;
                    string category = variants[nomer].category;



                    int pos = adress.find(category) ;
                    adress = adress.replace(pos, category.size(),category + "1");
                    */


                    Bed2[Active_Pic].picture = Bed2[Active_Pic].picture2;

                }




            //Удаление картинки путём смены местами Active_Pic и n_pics
            if(Active_Pic >= 0 && txMouseButtons() == 1 && GetAsyncKeyState(VK_DELETE) && klik == true)
            {
               /* char str[100];
                sprintf(str, "%d", Active_Pic);
                txMessageBox(str);*/

                if (n_pics > 1)
                {

                    Bed2[Active_Pic].height = Bed2[n_pics-1].height;
                    Bed2[Active_Pic].width = Bed2[n_pics-1].width;
                    Bed2[Active_Pic].x = Bed2[n_pics-1].x;
                    Bed2[Active_Pic].y = Bed2[n_pics-1].y;
                    Bed2[Active_Pic].picture = Bed2[n_pics-1].picture;
                }


                n_pics = n_pics - 1;
                Active_Pic = -999;
            }

            if(txMouseButtons () == 0)
                klik = true;

            //Анти попадание на чёрный цвет в плане
            /*for (int nomer = 0; nomer <  9; nomer = nomer + 1)
            nomer =

            if(txGetPixel(Bed2[Active_Pic].x, Bed2[Active_Pic].y) == TX_BLACK)
            {
                Bed2[Active_Pic].x = Bed2[Active_Pic].x + 200;
            }*/



            if(GetAsyncKeyState('P'))
            {
                PAGE = "start";
            }

            //А почему не сделать паузу 2 картинками как с настройками и плеем?
            /*if (txMouseX() >= 1210   && txMouseY() >=10  && txMouseX() <=1290 && txMouseY() <=50)
            {
                Pause.x_kadr = 1;
            }
            else
            {
                Pause.x_kadr = 0;
            }
              */
            /*if (txMouseX() >=1220   && txMouseY() >= 1  && txMouseX() <=1300 && txMouseY() <=77&&
                txMouseButtons () ==1)
            {
                txPlaySound("2.wav", SND_ASYNC);
                PAGE = "start";
            } */



            //Категория); планов квартиры
            drawAllPlans(category, Plans, count_Plans);
            //Рисование мебели
            drawAllBED2(Bed2, n_pics);
            drawAllVariants(category, variants, count_variants);

          //  txTransparentBlt (txDC(), Pause.x + 5, Pause.y , 80, 45, Pause.picture, 80 * Pause.x_kadr,  0, RGB(255, 127, 39));



            if (Button[5].click() && txMouseButtons() == 1)
            {
                //Открыть файл
                ofstream file2("картинки.txt");

                //Пробежать по всем картинкам
                for (int i = 0; i < n_pics; i++)
                {
                    //И сохранить вот это
                    file2 << Bed2[i].x << endl;
                    file2 << Bed2[i].y << endl;
                    file2 << Bed2[i].address << endl;
                }

                file2.close();

                txMessageBox("Успешно сохранено");

            }

            if (Button[6].click() && txMouseButtons() == 1)
            {

    OPENFILENAME ofn;			// структура стандартного диалогового окна
    char szFile[260];			// буфер для имени файла
    HWND hwnd;              		// окно владельца
    HANDLE hf;              		// дескриптор файла

    // Инициализация OPENFILENAME
    ZeroMemory(&ofn, sizeof(OPENFILENAME));
    ofn.lStructSize = sizeof(OPENFILENAME);
    ofn.hwndOwner = txWindow();
    ofn.lpstrFile = szFile;
    ofn.nMaxFile = sizeof(szFile);
    ofn.lpstrFilter = "All\0*.*\0Text\0*.TXT\0";
    ofn.nFilterIndex = 1;
    ofn.lpstrFileTitle = NULL;
    ofn.nMaxFileTitle = 0;
    ofn.lpstrInitialDir = NULL;
    ofn.Flags = OFN_PATHMUSTEXIST | OFN_FILEMUSTEXIST;

    // Покажем диалоговое окно Открыть (Open).

    if (GetOpenFileName(&ofn)==TRUE)
        hf = CreateFile(ofn.lpstrFile, GENERIC_READ,
            0, (LPSECURITY_ATTRIBUTES) NULL,
            OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL,
            (HANDLE) NULL);

              /*  //Прочитал первую строку
                ifstream file("картинки.txt");
                while (file.good())
                {
                    //Строка1 (x)
                    getline(file, strokaX);
                    Bed2[n_pics].x = atoi(strokaX.c_str());

                    //Строка2 (y)
                    getline(file, strokaY);
                    Bed2[n_pics].y = atoi(strokaY.c_str());

                    //Строка3 (адрес)
                    getline(file, address);
                    Bed2[n_pics].address = address.c_str();



                    Bed2[n_pics].visible = true;

                    Bed2[n_pics].picture = txLoadImage(Bed2[n_pics].address.c_str());
                    //Ширина и высота из свойств файла
                    Bed2[n_pics].width = getWidth (Bed2[n_pics].address.c_str());
                    Bed2[n_pics].height = getHeight(Bed2[n_pics].address.c_str());

                    n_pics = n_pics + 1;
                }

                txMessageBox("Загрузка...");*/
            }
        }

        txSleep(20);
        txEnd();
    }





    //Удаление картинок
    txDeleteDC(Fon);
    txDeleteDC(Strelka);
    txDeleteDC(Krestik);
    txDeleteDC(reklama);
    txDeleteDC(button_0);
    txDeleteDC(Plan_);
    //txDeleteDC(Button);
    //txDeleteDC(Plans);

    deletePicBed(variants, count_variants, Plans);
    //deletePic(Button, Button_MENU, Menu);

    return 0;
}
